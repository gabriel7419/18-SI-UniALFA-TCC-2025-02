<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout (~{::title/text()}, ~{::section}, ~{::script})}">
<head>
    <title>Alterar Senha</title>
</head>
<body>
<section>
    <div class="card card-primary">
        <div class="card-header card-header-blue">
            <h3 class="card-title">Alterar Senha</h3>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show m-3" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Fechar">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show m-3" role="alert">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Fechar">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form th:action="@{/admin/usuarios/alterar-senha/{id}(id=${usuario.id})}" method="post" novalidate>
            <div class="card-body">
                <div class="form-group mb-3" th:if="${requireCurrentPassword}">
                    <label for="currentPassword">Senha atual</label>
                    <input type="password" class="form-control" id="currentPassword" name="currentPassword" autocomplete="current-password">
                </div>
                <div class="form-group mb-2">
                    <label for="newPassword">Nova senha</label>
                    <input type="password" class="form-control" id="newPassword" name="newPassword" autocomplete="new-password" required>
                    <div id="password-strength" class="mt-1" style="display: none;" aria-live="polite">
                        <div class="progress" style="height: 6px;">
                            <div id="passwordStrengthBar" class="progress-bar bg-danger" style="width: 0%"></div>
                        </div>
                        <small id="passwordStrengthText" class="form-text text-muted"></small>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label for="confirmPassword">Confirmar nova senha</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" autocomplete="new-password" required>
                </div>
                <div id="policyMsg" class="text-danger small" style="display:none;"></div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-primary" id="saveBtn">Salvar</button>
                <a th:href="@{/admin/usuarios/editar/{id}(id=${usuario.id})}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</section>
<script th:inline="javascript">
(function() {
  var requireCurrent = /*[[${requireCurrentPassword}]]*/ true;
  function loadZxcvbn(cb) {
    if (typeof zxcvbn !== 'undefined') { cb(); return; }
    var s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js';
    s.async = true;
    s.onload = cb;
    document.head.appendChild(s);
  }
  function updateStrength(pwd, els) {
    if (!els) return {score:0};
    var box = els.box, bar = els.bar, text = els.text;
    if (!pwd) { box.style.display = 'none'; bar.style.width = '0%'; bar.className = 'progress-bar bg-danger'; text.textContent = ''; return {score:0}; }
    box.style.display = 'block';
    var res = (typeof zxcvbn !== 'undefined') ? zxcvbn(pwd) : { score: 0, feedback: {} };
    var score = Math.max(0, Math.min(4, res.score || 0));
    var perc = [5,25,50,75,100][score];
    var labels = ['Muito fraca','Fraca','Média','Forte','Excelente'];
    var classes = ['bg-danger','bg-danger','bg-warning','bg-success','bg-success'];
    bar.style.width = perc + '%';
    bar.className = 'progress-bar ' + classes[score];
    var msg = labels[score];
    if (res.feedback && res.feedback.warning) { msg += ' — ' + res.feedback.warning; }
    text.textContent = msg;
    return {score: score};
  }
  document.addEventListener('DOMContentLoaded', function(){
    var form = document.querySelector('form');
    var saveBtn = document.getElementById('saveBtn');
    var current = document.getElementById('currentPassword');
    var pwd = document.getElementById('newPassword');
    var confirm = document.getElementById('confirmPassword');
    var msg = document.getElementById('policyMsg');
    var els = { box: document.getElementById('password-strength'), bar: document.getElementById('passwordStrengthBar'), text: document.getElementById('passwordStrengthText') };
    var minScore = 3;
    var minLength = 8;

    function validate() {
      var s = updateStrength(pwd.value, els).score;
      var okScore = s >= minScore;
      var okLen = pwd.value.length >= minLength;
      var okMatch = pwd.value.length > 0 && pwd.value === confirm.value;
      var okCurrent = (!requireCurrent) || current.value.length > 0;
      var okDifferent = (!requireCurrent) || !current.value || pwd.value !== current.value;
      var ok = okLen && okScore && okMatch && okCurrent && okDifferent;
      if (!ok) {
        var parts = [];
        if (!okCurrent) parts.push('Informe a senha atual.');
        if (!okLen) parts.push('Senha deve ter no mínimo 8 caracteres.');
        if (!okScore) parts.push('Senha deve ser Forte ou Excelente.');
        if (!okMatch) parts.push('Confirmação não confere.');
        if (!okDifferent) parts.push('Nova senha não pode ser igual à atual.');
        msg.textContent = parts.join(' ');
        msg.style.display = 'block';
      } else {
        msg.textContent = '';
        msg.style.display = 'none';
      }
      if (saveBtn) saveBtn.disabled = !ok;
      return ok;
    }

    ['input','blur'].forEach(function(evt){
      [current,pwd,confirm].forEach(function(el){ if(el) el.addEventListener(evt, validate); });
    });

    loadZxcvbn(validate);

    if (form) {
      form.addEventListener('submit', function(e){
        if (!validate()) { e.preventDefault(); }
      });
    }
  });
})();
</script>
</body>
</html>
