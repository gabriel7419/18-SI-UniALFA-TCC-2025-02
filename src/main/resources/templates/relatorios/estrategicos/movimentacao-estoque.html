<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout (~{::title/text()}, ~{::section}, ~{::script})}">
<head>
    <title>Relatório de Movimentação de Estoque por Período</title>
</head>
<body>
    <section>
        <div class="card">
            <div class="card-header card-header-blue">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-exchange-alt"></i> Relatório de Movimentação de Estoque por Período
                    </h3>
                    <a th:href="@{/relatorios/estrategicos}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form id="filtroForm" method="get">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dataInicio"><i class="fas fa-calendar-alt"></i> Data Início:</label>
                                <input type="date" id="dataInicio" name="dataInicio" class="form-control" 
                                       th:value="${dataInicio}" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="dataFim"><i class="fas fa-calendar-alt"></i> Data Fim:</label>
                                <input type="date" id="dataFim" name="dataFim" class="form-control" 
                                       th:value="${dataFim}" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="tipo"><i class="fas fa-filter"></i> Tipo:</label>
                                <select id="tipo" name="tipo" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="ENTRADA">Entrada</option>
                                    <option value="SAIDA">Saída</option>
                                    <option value="AJUSTE_POSITIVO">Ajuste Positivo</option>
                                    <option value="AJUSTE_NEGATIVO">Ajuste Negativo</option>
                                    <option value="EXCLUSAO">Exclusão</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div class="btn-group btn-block">
                                    <button type="button" id="btnPdf" class="btn btn-danger">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </button>
                                    <button type="button" id="btnExcel" class="btn btn-success">
                                        <i class="fas fa-file-excel"></i> Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('hoje')">Hoje</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('semana')">Esta Semana</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('mes')">Este Mês</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('ultimomes')">Último Mês</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('trimestre')">Último Trimestre</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('semestre')">Último Semestre</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriodo('ano')">Este Ano</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <script>
        function setPeriodo(tipo) {
            const hoje = new Date();
            let dataInicio, dataFim;

            switch(tipo) {
                case 'hoje':
                    dataInicio = dataFim = hoje;
                    break;
                case 'semana':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setDate(hoje.getDate() - hoje.getDay());
                    break;
                case 'mes':
                    dataFim = hoje;
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    break;
                case 'ultimomes':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setMonth(hoje.getMonth() - 1);
                    break;
                case 'trimestre':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setMonth(hoje.getMonth() - 3);
                    break;
                case 'semestre':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setMonth(hoje.getMonth() - 6);
                    break;
                case 'ano':
                    dataFim = hoje;
                    dataInicio = new Date(hoje.getFullYear(), 0, 1);
                    break;
            }

            document.getElementById('dataInicio').value = formatDate(dataInicio);
            document.getElementById('dataFim').value = formatDate(dataFim);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        document.getElementById('btnPdf').addEventListener('click', function() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tipo = document.getElementById('tipo').value;
            
            if (!dataInicio || !dataFim) {
                alert('Por favor, selecione as datas de início e fim.');
                return;
            }

            let url = '/relatorios/estrategicos/movimentacao-estoque/pdf?dataInicio=' + dataInicio + '&dataFim=' + dataFim;
            if (tipo) {
                url += '&tipo=' + tipo;
            }
            window.open(url, '_blank');
        });

        document.getElementById('btnExcel').addEventListener('click', function() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tipo = document.getElementById('tipo').value;
            
            if (!dataInicio || !dataFim) {
                alert('Por favor, selecione as datas de início e fim.');
                return;
            }

            let url = '/relatorios/estrategicos/movimentacao-estoque/excel?dataInicio=' + dataInicio + '&dataFim=' + dataFim;
            if (tipo) {
                url += '&tipo=' + tipo;
            }
            window.location.href = url;
        });
    </script>
</body>
</html>
