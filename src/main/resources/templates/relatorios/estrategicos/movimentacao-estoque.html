<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout (~{::title/text()}, ~{::section}, ~{::script})}">
<head>
    <title>Relatório de Movimentação de Estoque por Período</title>
</head>
<body>
    <section>
        <!-- Mensagem de erro -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <!-- Filtros Colapsáveis -->
        <div class="card card-primary collapsed-card mb-3">
            <div class="card-header card-header-blue">
                <h3 class="card-title">Filtros</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" style="display: none;">
                <form id="filtroForm" method="get">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="dataInicio"><i class="fas fa-calendar-alt"></i> Data Início:</label>
                                <input type="date" id="dataInicio" name="dataInicio" class="form-control" 
                                       th:value="${dataInicio}" required>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="dataFim"><i class="fas fa-calendar-alt"></i> Data Fim:</label>
                                <input type="date" id="dataFim" name="dataFim" class="form-control" 
                                       th:value="${dataFim}" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="tipo"><i class="fas fa-filter"></i> Tipo:</label>
                                <select id="tipo" name="tipo" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="ENTRADA">Entrada</option>
                                    <option value="SAIDA">Saída</option>
                                    <option value="AJUSTE_POSITIVO">Ajuste Positivo</option>
                                    <option value="AJUSTE_NEGATIVO">Ajuste Negativo</option>
                                    <option value="EXCLUSAO">Exclusão</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label class="mb-2"><i class="fas fa-clock"></i> Períodos Rápidos:</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('hoje')">Hoje</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('semana')">Esta Semana</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('mes')">Este Mês</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('ultimomes')">Último Mês</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('trimestre')">Último Trimestre</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('semestre')">Último Semestre</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo('ano')">Este Ano</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card Principal -->
        <div class="card">
            <div class="card-header card-header-blue">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-exchange-alt"></i> Relatório de Movimentação de Estoque por Período
                    </h3>
                    <div class="card-tools mt-2 mt-md-0">
                        <button type="button" id="btnPdf" class="btn btn-danger btn-sm">
                            <i class="fas fa-file-pdf"></i> Gerar PDF
                        </button>
                        <button type="button" id="btnExcel" class="btn btn-success btn-sm">
                            <i class="fas fa-file-excel"></i> Gerar Excel
                        </button>
                        <a th:href="@{/relatorios/estrategicos}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Selecione o período desejado e, opcionalmente, o tipo de movimentação nos filtros acima. Clique em "Gerar PDF" ou "Gerar Excel".
                </div>
            </div>
        </div>
    </section>
    <script>
        function setPeriodo(tipo) {
            const hoje = new Date();
            let dataInicio, dataFim;

            switch(tipo) {
                case 'hoje':
                    dataInicio = dataFim = hoje;
                    break;
                case 'semana':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setDate(hoje.getDate() - hoje.getDay());
                    break;
                case 'mes':
                    dataFim = hoje;
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    break;
                case 'ultimomes':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setMonth(hoje.getMonth() - 1);
                    break;
                case 'trimestre':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setMonth(hoje.getMonth() - 3);
                    break;
                case 'semestre':
                    dataFim = hoje;
                    dataInicio = new Date(hoje);
                    dataInicio.setMonth(hoje.getMonth() - 6);
                    break;
                case 'ano':
                    dataFim = hoje;
                    dataInicio = new Date(hoje.getFullYear(), 0, 1);
                    break;
            }

            document.getElementById('dataInicio').value = formatDate(dataInicio);
            document.getElementById('dataFim').value = formatDate(dataFim);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        document.getElementById('btnPdf').addEventListener('click', function() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tipo = document.getElementById('tipo').value;
            
            if (!dataInicio || !dataFim) {
                return;
            }
            
            if (new Date(dataInicio) > new Date(dataFim)) {
                return;
            }

            let url = '/relatorios/estrategicos/movimentacao-estoque/pdf?dataInicio=' + dataInicio + '&dataFim=' + dataFim;
            if (tipo) {
                url += '&tipo=' + tipo;
            }
            window.open(url, '_blank');
        });

        document.getElementById('btnExcel').addEventListener('click', function() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tipo = document.getElementById('tipo').value;
            
            if (!dataInicio || !dataFim) {
                return;
            }
            
            if (new Date(dataInicio) > new Date(dataFim)) {
                return;
            }

            let url = '/relatorios/estrategicos/movimentacao-estoque/excel?dataInicio=' + dataInicio + '&dataFim=' + dataFim;
            if (tipo) {
                url += '&tipo=' + tipo;
            }
            window.location.href = url;
        });
    </script>
</body>
</html>
